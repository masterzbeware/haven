-- ‚úÖ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Made by MasterZ",
    Footer = "v2.0.0",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user")
}

local GroupBox = Tabs.Main:AddLeftGroupbox("Auto System")
local ShopBox = Tabs.Main:AddRightGroupbox("Shop")

-- ‚úÖ Auto NPC Toggle Setup
local Toggles = Library.Toggles
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local PromptEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("NpcAcceptPromptTriggered")

local MY_USER_ID = Players.LocalPlayer.UserId
local acceptedIds = {}

-- Fungsi: cek jika visitor penuh
local function isVisitorFull()
	local plots = Workspace:FindFirstChild("Plots")
	if not plots then return true end

	for _, plot in ipairs(plots:GetChildren()) do
		if plot:IsA("Part") and plot:GetAttribute("Owner") == MY_USER_ID then
			local sign = plot:FindFirstChild("Sign")
			if sign then
				local signFace = sign:FindFirstChild("SignFace")
				if signFace then
					local gui = signFace:FindFirstChildWhichIsA("SurfaceGui")
					if gui then
						local visitors = gui:FindFirstChild("Visitors")
						if visitors and visitors:IsA("TextLabel") then
							local counter = visitors:FindFirstChild("Counter")
							if counter and counter:IsA("TextLabel") then
								local current, max = string.match(counter.Text, "(%d+)/(%d+)")
								current, max = tonumber(current), tonumber(max)
								if current and max and current >= max then
									return true
								end
							end
						end
					end
				end
			end
		end
	end
	return false
end

-- Fungsi: accept visitor
local function acceptVisitor(npc)
	if npc:IsA("Model") and npc.Name:match("^visitor_%d+") then
		local owner = npc:GetAttribute("Owner")
		local id = npc:GetAttribute("Id")
		if owner == MY_USER_ID and typeof(id) == "string" and not acceptedIds[id] and id:match("^%b{}$") then
			if isVisitorFull() then return end
			acceptedIds[id] = true
			PromptEvent:FireServer(id)
			print("‚úÖ Accepted NPC:", id)
		end
	end
end

-- Loop global, berjalan terus tapi hanya aktif saat toggle nyala
RunService.Heartbeat:Connect(function()
	if Toggles.AutoNPC and Toggles.AutoNPC.Value then
		for _, npc in ipairs(Workspace:GetChildren()) do
			acceptVisitor(npc)
		end
	end

	if Toggles.AutoCollectSafe and Toggles.AutoCollectSafe.Value then
		local plots = Workspace:FindFirstChild("Plots")
		if plots then
			for _, plot in ipairs(plots:GetChildren()) do
				if plot:IsA("Part") and plot:GetAttribute("Owner") == MY_USER_ID then
					local safe = plot:FindFirstChild("Safe")
					if safe and safe:IsA("Model") then
						local hrp = safe:FindFirstChild("Hrp")
						if hrp and hrp:IsA("BasePart") then
							local prompt = hrp:FindFirstChild("Collect")
							if prompt and prompt:IsA("ProximityPrompt") and prompt.Enabled then
								fireproximityprompt(prompt, 0)
							end
						end
					end
				end
			end
		end
	end
end)

-- UI Toggle Auto NPC
GroupBox:AddToggle("AutoNPC", {
	Text = "Auto NPC",
	Default = false,
	Tooltip = "Terima visitor milik sendiri otomatis",
	Callback = function(v)
		if v then
			Library:Notify("‚úÖ Auto NPC aktif", 3)
		else
			Library:Notify("‚õî Auto NPC dimatikan", 3)
		end
	end,
})

-- ‚úÖ UI Toggle Auto Collect Safe
GroupBox:AddToggle("AutoCollectSafe", {
	Text = "Auto Collect Safe",
	Default = false,
	Tooltip = "Otomatis trigger prompt 'Collect' pada Safe",
	Callback = function(v)
		if v then
			Library:Notify("‚úÖ Auto Collect Safe aktif", 3)
		else
			Library:Notify("‚õî Auto Collect Safe dimatikan", 3)
		end
	end,
})

-- ‚úÖ SHOP DROPDOWN DENGAN FLOWERPOT
ShopBox:AddDropdown("ShopItem", {
    Values = {
        "Torch ($5)",
        "CampFire ($10)",
        "Chair ($5)",
        "FlowerPot ($20)"
    },
    Default = 1,
    Multi = false,
    Text = "Select Item",
    Tooltip = "Pilih item untuk dibeli dari Shop",
    Callback = function(selected)
        local itemMap = {
            ["Torch ($5)"] = "Torch_1",
            ["CampFire ($10)"] = "CampFire_1",
            ["Chair ($5)"] = "Chair_1",
            ["FlowerPot ($20)"] = "Flower_1"
        }

        local itemId = itemMap[selected]
        if itemId then
            local args = { itemId, false }
            game:GetService("ReplicatedStorage"):WaitForChild("Events")
                :WaitForChild("SuppliesBuy"):FireServer(unpack(args))
            Library:Notify("üõí Dibeli: " .. selected, 3)
        else
            Library:Notify("‚ùå Item tidak dikenal", 3)
        end
    end
})
